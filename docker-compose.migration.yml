version: "3.7"

services:
  directus:
    image: directus/directus:latest
    container_name: directus
    ports:
      - 8055:8055
    volumes:
      - directus_database:/directus/database
      - directus_uploads:/directus/uploads
    environment:
      KEY: "replace-with-random-value"
      SECRET: "replace-with-random-value"
      ADMIN_EMAIL: "admin@example.com"
      ADMIN_PASSWORD: "d1r3ctu5"
      DB_CLIENT: "sqlite3"
      DB_FILENAME: "/directus/database/data.db"
      WEBSOCKETS_ENABLED: true
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8055/server/health || exit 1
      interval: 10s
      timeout: 10s
      retries: 10

  initialize-db:
    image: alpine:latest
    container_name: initDb
    volumes: 
      - ./scripts:/scripts
    environment:
      DIRECTUS_URL: http://directus:8055
    command: >
      /bin/sh -c '
        apk add curl jq bash
        until curl -s http://directus:8055/server/health | grep -q "ok"; do
          echo "Waiting for directus to be ready..."
          sleep 5
        done
        /bin/bash ./scripts/directus/build-tables.sh
        /bin/bash ./scripts/directus/seed-data.sh
        /bin/bash ./scripts/directus/set-permissions.sh
      '

  mongodb:
    image: mongo:4.4.9-focal
    container_name: mongodb
    restart: always
    ports:
      - 27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: $MONGO_USERNAME
      MONGO_INITDB_ROOT_PASSWORD: $MONGO_PASSWORD
    volumes:
      - ./ignore/db:/data/db

  mongo-express:
    image: mongo-express:latest
    container_name: mongo-express
    restart: always
    ports:
      - 8081:8081
    environment:
      ME_CONFIG_MONGODB_SERVER: mongodb
      ME_CONFIG_MONGODB_ADMINUSERNAME: $MONGO_USERNAME
      ME_CONFIG_MONGODB_ADMINPASSWORD: $MONGO_PASSWORD
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: pass

volumes:
  directus_database:
  directus_uploads:
